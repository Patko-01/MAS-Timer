<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <title>MAS Timer</title>
    <style>
        body, html { height: 100%; }
        .timer-display { font-family: monospace; }
        .center-area { min-height: 60vh; }
        .laps { max-height: 220px; overflow:auto; }
        .lap-row .btn {
            padding: 1rem 1.5rem;
            font-size: 1.6rem;
            min-width: 180px;
            height: auto;
        }
        .lap-row .btn.btn-lg { padding: 1.05rem 1.6rem; }
        @media (max-width: 576px) {
            .lap-row .btn { font-size: 1.15rem; min-width: 120px; }
        }
    </style>
</head>
<body class="d-flex flex-column">

<main class="container my-4 d-flex flex-column align-items-center center-area">
    <h1 class="mb-4">MAS Timer</h1>

    <div class="card text-center p-4 mb-3 w-100" style="max-width:1024px;">
        <div class="mb-3">
            <div id="display" class="timer-display display-4">00:00.000</div>
        </div>

        <div class="d-flex justify-content-center gap-2 mb-2 flex-wrap">
            <button id="startBtn" class="btn btn-success">Start</button>
            <button id="stopBtn" class="btn btn-danger">Stop</button>
            <button id="exportBtn" class="btn btn-outline-secondary">Export TXT</button>
            <button id="resetBtn" class="btn btn-outline-danger">Reset</button>
        </div>

        <div class="d-flex justify-content-center gap-2 mb-3 lap-row">
            <button id="lapABtn" class="btn btn-primary btn-lg col-6">Lap A</button>
            <button id="lapBBtn" class="btn btn-info btn-lg col-6">Lap B</button>
        </div>

        <div class="row">
            <div class="col-6">
                <h6>Event A</h6>
                <ul id="lapsA" class="list-group laps"></ul>
            </div>
            <div class="col-6">
                <h6>Event B</h6>
                <ul id="lapsB" class="list-group laps"></ul>
            </div>
        </div>
    </div>

    <small class="text-muted">Press Start to begin, use Lap A / Lap B to record times for two different events. Export downloads a CSV. You can also use the left/right arrow keys for Lap A / Lap B. Press Space to start/stop.</small>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script>
    // Timer state
    let running = false;
    let startTime = 0;
    let elapsedBefore = 0; // ms
    let rafId = null;
    const displayEl = document.getElementById('display');

    // Laps
    const lapsA = [];
    const lapsB = [];

    // Buttons & lists
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const lapABtn = document.getElementById('lapABtn');
    const lapBBtn = document.getElementById('lapBBtn');
    const exportBtn = document.getElementById('exportBtn');
    const resetBtn = document.getElementById('resetBtn');
    const lapsAEl = document.getElementById('lapsA');
    const lapsBEl = document.getElementById('lapsB');

    // Audio (beep)
    let audioCtx = null;
    function playBeep(freq = 880, durationMs = 70) {
        try {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.0001, now);
            gain.gain.exponentialRampToValueAtTime(0.25, now + 0.005);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + durationMs / 1000);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + durationMs / 1000 + 0.02);
        } catch (e) {
            console.warn('beep failed', e);
        }
    }

    function formatTime(ms) {
        const totalMs = Math.max(0, Math.floor(ms));
        const minutes = Math.floor(totalMs / 60000);
        const seconds = Math.floor((totalMs % 60000) / 1000);
        const milliseconds = totalMs % 1000;
        return String(minutes).padStart(2,'0') + ':' + String(seconds).padStart(2,'0') + '.' + String(milliseconds).padStart(3,'0');
    }

    function update() {
        const now = performance.now();
        const elapsed = elapsedBefore + (now - startTime);
        displayEl.textContent = formatTime(elapsed);
        rafId = requestAnimationFrame(update);
    }

    function start() {
        if (running) return;
        running = true;
        startTime = performance.now();
        rafId = requestAnimationFrame(update);
    }

    function stop() {
        if (!running) return;
        running = false;
        cancelAnimationFrame(rafId);
        const now = performance.now();
        elapsedBefore += (now - startTime);
        displayEl.textContent = formatTime(elapsedBefore);
    }

    function resetAll() {
        stop();
        elapsedBefore = 0;
        displayEl.textContent = formatTime(0);
        lapsA.length = 0;
        lapsB.length = 0;
        renderLaps();
    }

    function currentElapsed() {
        if (running) {
            return elapsedBefore + (performance.now() - startTime);
        }
        return elapsedBefore;
    }

    // Helper: format total seconds with 3 decimals and pad integer part to at least 2 digits
    function formatSecondsMs(ms) {
        const totalSec = (ms / 1000);
        const parts = totalSec.toFixed(3).split('.');
        parts[0] = String(Number(parts[0])).padStart(2, '0');
        return parts.join('.');
    }

    function recordLap(bucket, listEl, arr) {
        playBeep();
        const t = currentElapsed(); // ms
        const secStr = formatSecondsMs(t); // ss.000 (integer part padded)
        const index = arr.length + 1;
        arr.push({ index, timeMs: Math.floor(t), timeStr: secStr });
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = index + '. ' + secStr;
        listEl.insertBefore(li, listEl.firstChild);
    }

    function renderLaps() {
        lapsAEl.innerHTML = '';
        lapsBEl.innerHTML = '';
        for (let i = lapsA.length - 1; i >= 0; i--) {
            const item = lapsA[i];
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = item.index + '. ' + item.timeStr;
            lapsAEl.appendChild(li);
        }
        for (let i = lapsB.length - 1; i >= 0; i--) {
            const item = lapsB[i];
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = item.index + '. ' + item.timeStr;
            lapsBEl.appendChild(li);
        }
    }

    function exportCSV() {
        const rows = [['event','time']];
        const sortedA = lapsA.slice().sort((a,b) => a.timeMs - b.timeMs);
        const sortedB = lapsB.slice().sort((a,b) => a.timeMs - b.timeMs);
        sortedA.forEach(item => rows.push(['lap A', item.timeStr]));
        sortedB.forEach(item => rows.push(['lap B', item.timeStr]));
        // Build a plain-text representation (comma-separated columns) and export as .txt
        const txtLines = rows.map(r => r.join(','));
        const txtContent = txtLines.join('\r\n');
        const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const now = new Date();
        const ts = now.toISOString().replace(/[:.]/g, '-');
        a.download = 'mas-timer-' + ts + '.txt';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    // Attach events
    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
    lapABtn.addEventListener('click', () => recordLap('A', lapsAEl, lapsA));
    lapBBtn.addEventListener('click', () => recordLap('B', lapsBEl, lapsB));
    exportBtn.addEventListener('click', exportCSV);
    resetBtn.addEventListener('click', resetAll);

    // Keyboard shortcuts: Space = toggle start/stop, ArrowLeft = Lap A, ArrowRight = Lap B
    document.addEventListener('keydown', (e) => {
        // ignore if typing into input (not applicable here but safe)
        const active = document.activeElement;
        if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) {
            return;
        }
        if (e.code === 'Space') {
            e.preventDefault();
            if (running) stop(); else start();
        } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            recordLap('A', lapsAEl, lapsA);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            recordLap('B', lapsBEl, lapsB);
        }
    });

    // initialize
    displayEl.textContent = formatTime(0);
</script>
</body>
</html>
